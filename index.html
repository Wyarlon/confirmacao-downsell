<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compra Confirmada - R$19,90</title>
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){
        w[l]=w[l]||[];w[l].push({'gtm.start': new Date().getTime(),event:'gtm.js'});
        var f=d.getElementsByTagName(s)[0], j=d.createElement(s), dl=l!='dataLayer'?'&l='+l:'';
        j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
        f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K3SZTP8L');</script>
    <!-- End Google Tag Manager -->
    
    <!-- Facebook Pixel (versão corrigida e otimizada) -->
    <script>
        // Configuração à prova de falhas
        if(!window._fbPixelLoaded) {
            window._fbPixelLoaded = true;
            
            // 1. Corrige localStorage e cookies
            const setupTrackingIds = () => {
                // Corrige fbclid
                const fbclid = new URLSearchParams(location.search).get('fbclid') 
                    || document.cookie.match(/fbclid=([^;]+)/)?.[1];
                
                if(fbclid && !localStorage.getItem('ultimo_fbclid')) {
                    localStorage.setItem('ultimo_fbclid', fbclid);
                    document.cookie = `fbclid=${fbclid}; path=/; max-age=2592000; SameSite=None; Secure`;
                }
                
                // Garante cookies do Facebook
                const domain = location.hostname.includes('github.io') 
                    ? '.github.io' 
                    : location.hostname;
                
                if(!document.cookie.includes('_fbp=')) {
                    const fbpValue = `fb.1.${Date.now()}.${Math.random().toString(36).substr(2,8)}`;
                    document.cookie = `_fbp=${fbpValue}; domain=${domain}; path=/; max-age=2592000; SameSite=None; Secure`;
                }
                
                if(!document.cookie.includes('_fbc=')) {
                    const fbcValue = `fb.1.${Date.now()}.${Math.random().toString(36).substr(2,8)}`;
                    document.cookie = `_fbc=${fbcValue}; domain=${domain}; path=/; max-age=2592000; SameSite=None; Secure`;
                }
                
                return fbclid || 'N/A';
            };

            // 2. Carrega o Pixel corretamente
            !function(f,b,e,v,n,t,s){
                if(f.fbq)return;
                n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};
                if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
                n.queue=[];t=b.createElement(e);t.async=!0;
                t.src=v;s=b.getElementsByTagName(e)[0];
                s.parentNode.insertBefore(t,s)
            }(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');

            // 3. Configuração moderna do Pixel
            fbq('init', '1345211853386206', { 
                autoConfig: true, 
                debug: new URLSearchParams(location.search).has('debug')
            });

            // 4. Dispara eventos após carregamento
            fbq('getBrowserId', function(browserId) {
                const fbclid = setupTrackingIds();
                const fbc = document.cookie.match(/_fbc=([^;]+)/)?.[1] || '';
                const fbp = document.cookie.match(/_fbp=([^;]+)/)?.[1] || browserId;

                // Facebook Pixel
                fbq('track', 'Purchase', {
                    value: 19.90,
                    currency: 'BRL',
                    contents: [{id: 'downsell_offer', quantity: 1}],
                    content_type: 'product',
                    fbclid: fbclid,
                    fbc: fbc,
                    fbp: fbp
                });

                // Google Tag Manager
                window.dataLayer = window.dataLayer || [];
                dataLayer.push({
                    'event': 'purchase_downsell',
                    'ecommerce': {
                        'purchase': {
                            'actionField': {
                                'id': fbclid,
                                'revenue': 19.90,
                                'currency': 'BRL'
                            },
                            'products': [{
                                'id': 'downsell_offer',
                                'name': 'Oferta Downsell',
                                'price': 19.90,
                                'quantity': 1
                            }]
                        }
                    },
                    'fbclid': fbclid,
                    'fbc': fbc,
                    'fbp': fbp
                });

                // Debug
                if(new URLSearchParams(location.search).has('debug')) {
                    console.table({
                        'FBClID': fbclid,
                        'Fonte FBClID': fbclid === 'N/A' ? 'Não encontrado' : 
                                         (new URLSearchParams(location.search).has('fbclid') ? 'URL' :
                                         document.cookie.includes('fbclid') ? 'Cookie' : 'LocalStorage',
                        '_fbc': fbc || 'Não encontrado',
                        '_fbp': fbp || 'Não encontrado',
                        'BrowserID': browserId,
                        'Pixel Status': 'Configurado com sucesso'
                    });
                }
            });
        }
    </script>
</head>
<body style="font-family: Arial; text-align: center; padding: 50px; background: #f5f5f5;">
    <!-- Google Tag Manager (noscript) -->
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K3SZTP8L"
        height="0" width="0" style="display:none;visibility:hidden"></iframe>
    </noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <!-- Facebook Pixel (noscript) -->
    <noscript>
        <img height="1" width="1" src="https://www.facebook.com/tr?id=1345211853386206&ev=Purchase&noscript=1"/>
    </noscript>
    
    <h1>✅ Compra confirmada!</h1>
    <p>Obrigado por adquirir nossa oferta especial por <strong>R$19,90</strong>.</p>
    <p>Aguarde, você será redirecionado...</p>
    
    <script>
        // Redirecionamento controlado
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('debug') !== 'true') {
            setTimeout(() => {
                window.location.href = "https://compra-confirmada.my.canva.site";
            }, 3000);
        } else {
            console.log("Modo debug ativo - Redirecionamento desativado.");
        }
    </script>
</body>
</html>
