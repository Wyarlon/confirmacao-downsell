<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compra Confirmada - R$19,90</title>
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){
        w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});
        var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';
        j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;
        f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-K3SZTP8L');</script>
    <!-- End Google Tag Manager -->

    <!-- Facebook Pixel Configuração -->
    <script>
        // Configuração otimizada
        !function(f,b,e,v,n,t,s){
            if(f.fbq)return;
            n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};
            if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
            n.queue=[];t=b.createElement(e);t.async=!0;
            t.src=v;s=b.getElementsByTagName(e)[0];
            s.parentNode.insertBefore(t,s)
        }(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
        
        fbq('init', '1345211853386206'); // SEU PIXEL ID
        fbq('track', 'PageView');
        
        // Função principal de rastreamento
        function trackPurchase() {
            // 1. Recupera identificadores de forma segura
            let fbclid, fbc, fbp;
            
            try {
                fbclid = localStorage.getItem('ultimo_fbclid') || 
                        document.cookie.match(/fbclid=([^;]+)/)?.[1] || 
                        'N/A';
                
                fbc = document.cookie.match(/_fbc=([^;]+)/)?.[1] || '';
                fbp = document.cookie.match(/_fbp=([^;]+)/)?.[1] || '';
            } catch(e) {
                console.error("Erro ao ler cookies:", e);
                fbclid = 'N/A';
                fbc = '';
                fbp = '';
            }

            // 2. Dispara Pixel do Facebook
            try {
                fbq('track', 'Purchase', {
                    value: 19.90,
                    currency: 'BRL',
                    content_ids: ['downsell_offer'],
                    content_type: 'product',
                    fbclid: fbclid,
                    fbc: fbc,
                    fbp: fbp
                });
            } catch(e) {
                console.error("Erro no Facebook Pixel:", e);
            }

            // 3. Dispara GTM
            try {
                window.dataLayer = window.dataLayer || [];
                dataLayer.push({
                    'event': 'purchase_downsell',
                    'value': 19.90,
                    'currency': 'BRL',
                    'fbclid': fbclid,
                    'fbc': fbc,
                    'fbp': fbp
                });
            } catch(e) {
                console.error("Erro no dataLayer:", e);
            }

            // 4. Debug (apenas em modo teste)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('debug')) {
                console.table({
                    'FBClID': fbclid,
                    'Fonte FBClID': fbclid === 'N/A' ? 'Não encontrado' : 
                                   (localStorage.getItem('ultimo_fbclid') ? 'LocalStorage' : 'Cookie'),
                    '_fbc': fbc || 'Não encontrado',
                    '_fbp': fbp || 'Não encontrado',
                    'Pixel Status': 'Disparado com sucesso'
                });
            }
        }
        
        // Dispara quando a página carregar
        if(document.readyState === 'complete') {
            trackPurchase();
        } else {
            window.addEventListener('DOMContentLoaded', trackPurchase);
        }
    </script>
</head>
<body style="font-family: Arial; text-align: center; padding: 50px; background: #f5f5f5;">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-K3SZTP8L"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <h1>✅ Compra confirmada!</h1>
    <p>Obrigado por adquirir nossa oferta especial por <strong>R$19,90</strong>.</p>
    <p>Aguarde, você será redirecionado...</p>
    
    <script>
        // Redirecionamento seguro e condicional
        const urlParams = new URLSearchParams(window.location.search);
        
        // Fluxo normal (sem debug)
        if (!urlParams.has('debug')) {
            // Armazena fbclid da URL se existir
            if(urlParams.has('fbclid')) {
                const fbclid = urlParams.get('fbclid');
                try {
                    localStorage.setItem('ultimo_fbclid', fbclid);
                    document.cookie = `fbclid=${fbclid}; path=/; max-age=2592000; SameSite=Lax`;
                } catch(e) {
                    console.error("Erro ao armazenar fbclid:", e);
                }
            }
            
            // Redireciona após 3 segundos
            setTimeout(() => {
                window.location.href = "https://compra-confirmada.my.canva.site";
            }, 3000);
        }
        // Modo debug (apenas exibe mensagem)
        else {
            console.log("Modo debug ativo - Redirecionamento desativado.");
        }
    </script>
</body>
</html>
