<script>
    // Configuração à prova de erros
    if(!window._facebookSetup) {
        window._facebookSetup = true;
        
        // 1. Garante cookies mesmo em modo debug
        if(new URLSearchParams(location.search).has('debug')) {
            const domain = location.hostname.includes('github.io') 
                ? '.github.io' 
                : location.hostname;
                
            if(!document.cookie.match(/_fbp=/)) {
                document.cookie = `_fbp=fb.1.${Date.now()}.${Math.random().toString(36).substr(2, 8)}; domain=${domain}; path=/; max-age=2592000; SameSite=None; Secure`;
            }
            if(!document.cookie.match(/_fbc=/)) {
                document.cookie = `_fbc=fb.1.${Date.now()}.${Math.random().toString(36).substr(2, 8)}; domain=${domain}; path=/; max-age=2592000; SameSite=None; Secure`;
            }
        }

        // 2. Inicialização segura do Pixel
        !function(f,b,e,v,n,t,s) {
            if(f.fbq)return;
            n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};
            if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
            n.queue=[];t=b.createElement(e);t.async=!0;
            t.src=v;s=b.getElementsByTagName(e)[0];
            s.parentNode.insertBefore(t,s)
        }(window,document,'script','https://connect.facebook.net/en_US/fbevents.js');
        
        fbq('init', '1345211853386206', {
            autoConfig: true,
            debug: true
        });
    }

    // 3. Disparo com verificação completa
    function firePixel() {
        const fbclid = localStorage.getItem('ultimo_fbclid') || 
                     document.cookie.match(/fbclid=([^;]+)/)?.[1] || 
                     'N/A';
        
        const fbc = document.cookie.match(/_fbc=([^;]+)/)?.[1] || '';
        const fbp = document.cookie.match(/_fbp=([^;]+)/)?.[1] || '';

        console.log('Dados capturados:', {fbclid, fbc, fbp});

        fbq('track', 'Purchase', {
            value: 19.90,
            currency: 'BRL',
            contents: [{
                id: 'downsell_offer',
                quantity: 1
            }],
            content_type: 'product',
            fbclid: fbclid,
            fbc: fbc,
            fbp: fbp
        });

        // GTM
        window.dataLayer = window.dataLayer || [];
        dataLayer.push({
            'event': 'purchase_downsell',
            'ecommerce': {
                'purchase': {
                    'actionField': {
                        'id': fbclid,
                        'revenue': 19.90,
                        'currency': 'BRL'
                    },
                    'products': [{
                        'id': 'downsell_offer',
                        'name': 'Oferta Downsell',
                        'price': 19.90,
                        'quantity': 1
                    }]
                }
            },
            'fbclid': fbclid,
            'fbc': fbc,
            'fbp': fbp
        });
    }

    // Dispara quando o Pixel estiver pronto
    if(window.fbq) {
        fbq('ready', firePixel);
    } else {
        document.addEventListener('fbq:ready', firePixel);
    }
</script>
